<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phishing Detection - URL Submission</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input[type="text"],
        input[type="url"],
        textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        input[type="text"]:focus,
        input[type="url"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .hint {
            color: #999;
            font-size: 12px;
            margin-top: 6px;
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result {
            margin-top: 20px;
            padding: 16px;
            border-radius: 8px;
            display: none;
        }

        .result.active {
            display: block;
        }

        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .result-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .result-details {
            font-size: 14px;
            line-height: 1.6;
        }

        .result-details strong {
            color: #333;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .status-indicator.connected {
            background: #28a745;
        }

        .status-indicator.disconnected {
            background: #dc3545;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 12px;
        }

        .status-item {
            display: flex;
            align-items: center;
        }

        .pipeline-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 12px;
            margin: 20px 0;
            border-radius: 4px;
            font-size: 13px;
            color: #1565c0;
        }

        .pipeline-info strong {
            display: block;
            margin-bottom: 4px;
        }

        .pipeline-info.direct {
            background: #e8f5e9;
            border-left-color: #4caf50;
            color: #2e7d32;
        }

        .checkbox-group {
            margin: 20px 0;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }

        .checkbox-hint {
            margin-top: 8px;
            margin-left: 30px;
            font-size: 12px;
            color: #666;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ°Ô∏è Phishing Detection Pipeline</h1>
        <p class="subtitle">Submit suspicious URLs or domains for comprehensive analysis</p>

        <div class="status-bar" id="statusBar">
            <div class="status-item">
                <span class="status-indicator disconnected" id="statusIndicator"></span>
                <span id="statusText">Checking connection...</span>
            </div>
            <div class="status-item">
                <span id="uptimeText">-</span>
            </div>
        </div>

        <div class="checkbox-group">
            <label class="checkbox-label">
                <input type="checkbox" id="fullPipelineCheckbox">
                <span>Start Full Flow (includes DNSTwist variant generation)</span>
            </label>
            <div class="checkbox-hint">
                <strong>Unchecked (Default):</strong> Fast analysis - directly process this specific URL (2-3 min)<br>
                <strong>Checked:</strong> Full analysis - generate and analyze typosquatting variants (3-5 min, ~50+ variants)
            </div>
        </div>

        <div class="pipeline-info direct" id="pipelineInfo">
            <strong id="pipelineTitle">‚ö° Direct Pipeline Analysis</strong>
            <span id="pipelineDescription">
                This will analyze the specific URL directly through DNS resolution, WHOIS lookup, SSL certificate analysis, and webpage feature extraction. Perfect for analyzing user-reported suspicious links.
                <br><br>
                ‚è±Ô∏è Expected processing time: <strong>2-3 minutes</strong>
            </span>
        </div>

        <div class="checkbox-group" style="margin-bottom: 20px;">
            <label class="checkbox-label">
                <input type="checkbox" id="bulkModeCheckbox">
                <span>Bulk Upload Mode (CSV)</span>
            </label>
            <div class="checkbox-hint">
                Upload a CSV file with multiple URLs for bulk processing (max 10,000)
            </div>
        </div>

        <form id="submitForm">
            <div class="form-group" id="singleUrlGroup">
                <label for="urlInput">URL or Domain *</label>
                <input
                    type="text"
                    id="urlInput"
                    name="url"
                    placeholder="https://suspicious-site.com or example.com"
                    required
                    autocomplete="off"
                >
                <div class="hint">Enter a full URL or just the domain name</div>
            </div>

            <div class="form-group" id="bulkUploadGroup" style="display: none;">
                <label for="csvFileInput">CSV File *</label>
                <input
                    type="file"
                    id="csvFileInput"
                    name="csv"
                    accept=".csv,.txt"
                >
                <div class="hint">CSV with 'url' column or one URL per line (max 10,000)</div>
            </div>

            <div class="form-group">
                <label for="cseIdInput">Brand/CSE ID (Optional)</label>
                <input
                    type="text"
                    id="cseIdInput"
                    name="cse_id"
                    placeholder="e.g., SBI, ICICI, HDFC"
                    autocomplete="off"
                >
                <div class="hint">Target brand identifier for better categorization</div>
            </div>

            <div class="form-group">
                <label for="notesInput">Notes (Optional)</label>
                <textarea
                    id="notesInput"
                    name="notes"
                    placeholder="e.g., Reported by customer, Found in spam email"
                ></textarea>
                <div class="hint">Additional context about this submission</div>
            </div>

            <button type="submit" id="submitBtn">
                üöÄ Submit for Analysis
            </button>
        </form>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="margin-top: 10px; color: #666;">Submitting to pipeline...</p>
        </div>

        <div class="result" id="result">
            <div class="result-title" id="resultTitle"></div>
            <div class="result-details" id="resultDetails"></div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let healthCheckInterval;

        // Update pipeline info based on checkbox state
        function updatePipelineInfo() {
            const checkbox = document.getElementById('fullPipelineCheckbox');
            const pipelineInfo = document.getElementById('pipelineInfo');
            const pipelineTitle = document.getElementById('pipelineTitle');
            const pipelineDescription = document.getElementById('pipelineDescription');

            if (checkbox.checked) {
                // Full pipeline mode
                pipelineInfo.className = 'pipeline-info';
                pipelineTitle.textContent = 'üìã Full Pipeline Analysis';
                pipelineDescription.innerHTML = `
                    This will analyze the URL through the complete pipeline including DNS resolution, WHOIS lookup, SSL certificate analysis, webpage feature extraction, and DNSTwist variant generation. Perfect for brand monitoring and detecting typosquatting attacks.
                    <br><br>
                    ‚è±Ô∏è Expected processing time: <strong>3-5 minutes</strong> (generates ~50+ domain variants)
                `;
            } else {
                // Direct pipeline mode
                pipelineInfo.className = 'pipeline-info direct';
                pipelineTitle.textContent = '‚ö° Direct Pipeline Analysis';
                pipelineDescription.innerHTML = `
                    This will analyze the specific URL directly through DNS resolution, WHOIS lookup, SSL certificate analysis, and webpage feature extraction. Perfect for analyzing user-reported suspicious links.
                    <br><br>
                    ‚è±Ô∏è Expected processing time: <strong>2-3 minutes</strong>
                `;
            }
        }

        // Toggle bulk mode UI
        function toggleBulkMode() {
            const bulkMode = document.getElementById('bulkModeCheckbox').checked;
            const singleUrlGroup = document.getElementById('singleUrlGroup');
            const bulkUploadGroup = document.getElementById('bulkUploadGroup');
            const urlInput = document.getElementById('urlInput');
            const csvInput = document.getElementById('csvFileInput');

            if (bulkMode) {
                singleUrlGroup.style.display = 'none';
                bulkUploadGroup.style.display = 'block';
                urlInput.removeAttribute('required');
                csvInput.setAttribute('required', 'required');
            } else {
                singleUrlGroup.style.display = 'block';
                bulkUploadGroup.style.display = 'none';
                urlInput.setAttribute('required', 'required');
                csvInput.removeAttribute('required');
            }
        }

        // Attach checkbox event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const checkbox = document.getElementById('fullPipelineCheckbox');
            checkbox.addEventListener('change', updatePipelineInfo);

            const bulkCheckbox = document.getElementById('bulkModeCheckbox');
            bulkCheckbox.addEventListener('change', toggleBulkMode);
        });

        // Check API health on load
        async function checkHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();

                const indicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                const uptimeText = document.getElementById('uptimeText');

                if (data.status === 'healthy' && data.kafka.connected) {
                    indicator.className = 'status-indicator connected';
                    statusText.textContent = '‚úÖ Connected to pipeline';
                } else {
                    indicator.className = 'status-indicator disconnected';
                    statusText.textContent = '‚ùå Pipeline unavailable';
                }

                const uptime = Math.floor(data.uptime);
                uptimeText.textContent = `Uptime: ${uptime}s`;
            } catch (error) {
                const indicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                indicator.className = 'status-indicator disconnected';
                statusText.textContent = '‚ùå Cannot reach API';
                console.error('Health check failed:', error);
            }
        }

        // Show result message
        function showResult(success, title, details) {
            const result = document.getElementById('result');
            const resultTitle = document.getElementById('resultTitle');
            const resultDetails = document.getElementById('resultDetails');

            result.className = `result active ${success ? 'success' : 'error'}`;
            resultTitle.textContent = title;
            resultDetails.innerHTML = details;

            // Auto-hide after 10 seconds for errors, keep success visible
            if (!success) {
                setTimeout(() => {
                    result.classList.remove('active');
                }, 10000);
            }
        }

        // Parse CSV file
        async function parseCSV(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim());

                    // Check if first line is header
                    const hasHeader = lines[0].toLowerCase().includes('url');
                    const startIndex = hasHeader ? 1 : 0;

                    const urls = lines.slice(startIndex).map(line => {
                        // Handle CSV with comma or just plain list
                        const parts = line.split(',');
                        return parts[0].trim();
                    }).filter(url => url);

                    resolve(urls);
                };
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        // Handle form submission
        document.getElementById('submitForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const loading = document.getElementById('loading');
            const result = document.getElementById('result');

            const bulkMode = document.getElementById('bulkModeCheckbox').checked;
            const cseId = document.getElementById('cseIdInput').value.trim();
            const notes = document.getElementById('notesInput').value.trim();
            const useFullPipeline = document.getElementById('fullPipelineCheckbox').checked;

            // Show loading state
            submitBtn.disabled = true;
            loading.classList.add('active');
            result.classList.remove('active');

            try {
                if (bulkMode) {
                    // Bulk submission
                    const csvFile = document.getElementById('csvFileInput').files[0];
                    if (!csvFile) {
                        throw new Error('Please select a CSV file');
                    }

                    console.log('üì§ Parsing CSV file...');
                    const urls = await parseCSV(csvFile);
                    console.log(`üì§ Submitting ${urls.length} URLs in bulk`);

                    const response = await fetch(`${API_BASE}/api/submit-bulk`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            urls: urls,
                            cse_id: cseId || undefined,
                            notes: notes || undefined,
                            use_full_pipeline: useFullPipeline
                        })
                    });

                    const data = await response.json();
                    console.log('üì• Response:', data);

                    if (response.ok && data.success) {
                        console.log('‚úÖ Bulk submission successful');
                        showResult(true,
                            '‚úÖ Bulk Submission Successful!',
                            `
                                <strong>Job ID:</strong> ${data.job_id}<br>
                                <strong>Total:</strong> ${data.summary.total_submitted}<br>
                                <strong>Queued:</strong> ${data.summary.successfully_queued}<br>
                                <strong>Failed:</strong> ${data.summary.failed}<br>
                                <strong>Pipeline:</strong> ${data.summary.pipeline}<br>
                                <strong>Estimated Time:</strong> ${data.timing.estimated_total_minutes} minutes<br>
                                <br>
                                <strong>Track progress:</strong> GET /api/job/${data.job_id}
                            `
                        );

                        // Clear form
                        document.getElementById('submitForm').reset();
                        document.getElementById('bulkModeCheckbox').checked = false;
                        toggleBulkMode();
                    } else {
                        console.error('‚ùå Bulk submission failed:', data.error);
                        showResult(false,
                            '‚ùå Bulk Submission Failed',
                            `<strong>Error:</strong> ${data.error || 'Unknown error'}`
                        );
                    }

                } else {
                    // Single submission
                    const url = document.getElementById('urlInput').value.trim();
                    console.log('üì§ Submitting URL:', url);
                    console.log('üîß Full Pipeline:', useFullPipeline);

                    const response = await fetch(`${API_BASE}/api/submit`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            url: url,
                            cse_id: cseId || undefined,
                            notes: notes || undefined,
                            use_full_pipeline: useFullPipeline
                        })
                    });

                    const data = await response.json();
                    console.log('üì• Response:', data);

                    if (response.ok && data.success) {
                        console.log('‚úÖ Submission successful');
                        showResult(true,
                        '‚úÖ Successfully Submitted!',
                        `
                            <strong>Domain:</strong> ${data.domain}<br>
                            <strong>Kafka Topic:</strong> ${data.kafka_topic}<br>
                            <strong>Partition:</strong> ${data.kafka_partition} | <strong>Offset:</strong> ${data.kafka_offset}<br>
                            <strong>Pipeline:</strong> ${data.pipeline}<br>
                            <strong>Processing Time:</strong> ${data.estimated_processing_time}<br>
                            <br>
                            <strong>Next Steps:</strong><br>
                            ‚Ä¢ Your domain is now in the analysis pipeline<br>
                            ‚Ä¢ It will go through: DNS ‚Üí WHOIS ‚Üí HTTP ‚Üí SSL ‚Üí Feature Extraction<br>
                            ‚Ä¢ Check ChromaDB in 3-5 minutes for results<br>
                        `
                    );

                        // Clear form
                        document.getElementById('submitForm').reset();
                    } else {
                        console.error('‚ùå Submission failed:', data.error);
                        showResult(false,
                            '‚ùå Submission Failed',
                            `<strong>Error:</strong> ${data.error || 'Unknown error'}<br>
                             <strong>Details:</strong> ${data.details || 'Please try again'}`
                        );
                    }
                }
            } catch (error) {
                console.error('üí• Network error:', error);
                showResult(false,
                    '‚ùå Network Error',
                    'Could not reach the API. Please check your connection and try again.'
                );
            } finally {
                // Hide loading state
                submitBtn.disabled = false;
                loading.classList.remove('active');
            }
        });

        // Initialize
        checkHealth();
        healthCheckInterval = setInterval(checkHealth, 10000); // Check every 10 seconds

        console.log('üöÄ Phishing Detection Frontend Loaded');
        console.log('üì° API Base:', API_BASE);
    </script>
</body>
</html>
